# 事件循环

### **浏览器有哪些进程和线程？**

- 浏览器进程
    
    界面显示、用户交互、子进程管理
    
- 网络进程
- 渲染进程
    
    启动后，会开启一个渲染主线程，执行HTML、CSS、JS
    
    每个标签页都有一个渲染进程，保证标签页之间不相互影响
    

### **渲染主进程是如何工作的？**

### **渲染主线程要处理的任务：**

- 解析 HTML
- 解析 CSS
- 计算样式
- 布局
- 处理图层
- 每秒绘制页面 60 次
- 执行全局 js 代码
- 执行计时器的回调函数
- ……

### **如何处理任务调度？**

### **事件循环（消息循环）**

![https://raw.githubusercontent.com/littleJH/PicBed/main/img/image-20240618161803817.png](https://raw.githubusercontent.com/littleJH/PicBed/main/img/image-20240618161803817.png)

1. 渲染主线程进入一个无限循环
2. 每次循环会检查消息队列中是否有任务存在。如果有，去除第一个执行并进入循环，否则进入休眠状态
3. 其他所有线程（包括其他进程的线程）可以向消息队列添加任务

### **若干解释**

### **何为异步？**

无法立即执行的任务：

- 计时完成后要完成的任务 `setTimeout` `setInterval`
- 网络通信完成后要执行的任务 `XHR` `Fetch`
- 用户操作后需要执行的任务 `addEventListener`

**面试题：如何理解JS的异步？**

> 说明JS的本质：JS是一门单线程语言，这是因为**JS运行在浏览器的渲染主线程中**，而渲染主线程只有一个。渲染主线程的工作内容：渲染主线程承担着诸多工作：渲染页面、执行JS等。

同步带来的后果：如果使用同步的方式，就极有可能导致主线程的阻塞，从而导致消息队列中其他任务无法得到执行。一方面导致繁忙的主线程白白浪费时间，另一方面导致页面无法及时更新，给用户造成卡死的现象。

异步解决方案：所以浏览器采用异步的方式来避免阻塞。具体做法：当执行某些任务时，如网络请求、计时器、事件监听等，主线程将任务交给其他线程去处理，自身立即结束任务的执行，转而执行后续代码。当其他线程执行完成后，将传递的**回调函数包装成任务**，加入到消息队列的末尾，等待主线程的调度执行。

结论：在这种异步模式下，浏览器永不阻塞，最大限度保证单线程的流畅运行。
> 

### **JS为何会阻碍渲染？**

根本原因：JS代码和页面渲染都由渲染主线程执行！！！

### **任务有优先级吗？**

**任务没有优先级，但是消息队列有优先级！**

根据 W3C 的最新解释：

> 每个任务都有一个任务类型。同一类型的任务必须在同一个队列。一个队列可以有不同类型的任务。浏览器必须准备好一个微任务队列，队列中任务优于其他任务执行。
> 

> 随着浏览器的复杂度提升，W3C 不再使用宏任务队列的说法。
> 

目前 Chrome 浏览器，至少包含以下队列：

- 微队列：需要最快执行的任务，优先级 [最高]
- 交互队列：用户事件回调，优先级 [高]
- 延时队列：计时器的回调，优先级 [中]

### **结论**

- 单线程是异步产生的原因！
- 事件循环是异步的解决方案！

**面试题：阐述一下 JS 的事件循环**

> 事件循环又叫消息循环，是浏览器渲染主线程的工作方式。
> 
> 
> 在 Chrome 浏览器的实现中，会开启一个不会结束的 for 循环，每次从消息队列中取出一个任务执行，而其他线程只需要在必要的时候将任务添加到消息队列的末尾。
> 
> 过去将消息队列简单分为宏任务队列和微任务队列，这种做法已经满足不了当前复杂的浏览器环境，取而代之的是将任务按类型划分，并赋予优先级，优先级高的在事件循环中先被执行。
> 
> 根据 W3C 标准，不同任务有不同的类型，同类型的任务必须处于同一个队列中，一个队列可以包含不同类型的任务。各种类型的任务被赋予不同的优先级，并由浏览器决定任务优先执行顺序。但浏览器必须要有一个微任务队列，该队列里的任务具有最高优先级，必须优先调度执行。
> 

**面试题：JS 中的计时器能做到精准计时吗？为什么？**

> 不能。
> 
> - 从硬件上将：计算机没有原子钟，无法做到精确计时。
> - 操作系统的计时函数本身存在一定误差，而 JS 的计时器本质上是调用操作系统的计时器。
> - 根据 W3C 的标准，当浏览器实现计时器时，如果嵌套层级超过 5 层，就会带有 4 毫秒的最少时间。
> - 受事件循环的影响，计时器的回调函数只会在主线程空闲时执行。