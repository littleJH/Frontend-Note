# è§‚å¯Ÿè€…æ¨¡å¼

åˆå«ï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼

ä¸¤ä¸ªå…³é”®è§’è‰²ï¼šå‘å¸ƒè€…ï¼Œè®¢é˜…è€…

### å‘å¸ƒè®¢é˜…çš„ç®€å•å®žçŽ°

```jsx
// å‘å¸ƒè€…
class Publisher {
  constructor(state) {
    // çŠ¶æ€
    this.state = state
    // è®¢é˜…è€…é›†åˆ
    this.observers = new Set()
  }

	// èŽ·å–çŠ¶æ€
  getState() {
    return this.state
  }

	// æ›´æ–°çŠ¶æ€
  setState(state) {
    console.log('ðŸš€ ~ Publisher ~ setState ~ state:', state)
    this.state = state
    // é€šçŸ¥è®¢é˜…è€…
    this.notify()
  }

	// æ·»åŠ è®¢é˜…è€…
  addObserver(observer) {
    observer && Array.isArray(observer) ? observer.map((item) => this.observers.add(observer)) : this.observers.add(observer)
  }

	// ç§»é™¤è®¢é˜…è€…
  removeObserver(observer) {
    this.observers.delete(observer)
  }

	// é€šçŸ¥è®¢é˜…è€…
  notify() {
    console.log('ðŸš€ ~ Publisher ~ notify')
    // éåŽ†è®¢é˜…è€…é›†åˆï¼Œè°ƒç”¨è®¢é˜…è€…çš„æ›´æ–°æ–¹æ³•ï¼Œä¼ å…¥æ–°çš„çŠ¶æ€
    this.observers.forEach((observer) => observer.update(this.state))
  }
}

// è®¢é˜…è€…
class Observer {
  constructor() {}

  update(state) {
    console.log('ðŸš€ ~ observer ~ update ~ state:', state)
  }
}

const observer = new Observer()
const observer1 = new Observer()
const publisher = new Publisher({
  name: 'zjh',
})
publisher.addObserver([observer, observer1])
publisher.setState({
  name: 'lcl',
})
```

### `EventBus` çš„å®žçŽ°

éœ€è¦å®žçŽ°çš„æ–¹æ³•ï¼š

- `on(name, cb)`
- `emit(name, val)`
- `off(name, cb)`
- `once(name, cb)`

```jsx
class EventBus {
  constructor() {
    this.handlerMap = new Map()
  }

  /**
   * å®‰è£…äº‹ä»¶ç›‘å¬å™¨
   *
   * @param eventName {String} äº‹ä»¶å
   * @param callback {Function} äº‹ä»¶å›žè°ƒ
   */
  on(eventName, callback) {
    const map = this.handlerMap
    if (!map.get(eventName)) {
      map.set(eventName, new Set())
    }
    map.get(eventName).add(callback)
  }

  /**
   * è§¦å‘ç›®æ ‡äº‹ä»¶
   *
   * @param eventName {Stirng} äº‹ä»¶å
   * @param value { Any } éœ€è¦ä¼ é€’ç»™ç›‘å¬å™¨çš„å‚æ•°
   */
  emit(eventName, value) {
    this.handlerMap.get(eventName) && this.handlerMap.get(eventName).forEach((cb) => cb(value))
  }

  /**
   * ç§»é™¤æŒ‡å®šäº‹ä»¶çš„æŒ‡å®šå›žè°ƒ
   *
   * @param eventName {String} äº‹ä»¶å
   * @param callback {Function} æŒ‡å®šè¦åˆ é™¤çš„äº‹ä»¶çš„å›žè°ƒ
   */
  off(eventName, callback) {
    console.log('ðŸš€ ~ EventBus ~ off ~ eventName, callback:', eventName, callback)
    this.handlerMap.get(eventName).delete(callback)
  }

  /**
   * ä¸ºäº‹ä»¶æ³¨å†Œå•æ¬¡ç›‘å¬å™¨
   * è§¦å‘ä¸€æ¬¡åŽè‡ªåŠ¨åˆ é™¤
   *
   * @param eventName {String} äº‹ä»¶å
   * @param callback {Fcuntin} äº‹ä»¶å›žè°ƒ
   */
  once(eventName, callback) {
    this.on(eventName, (val) => {
      callback(val)
      this.off(eventName, callback)
    })
  }
}

const bus = new EventBus()

bus.on('myevent', (val) => {
  console.log('ðŸš€ ~ bus.on ~ val:', val)
})

setTimeout(() => {
  Promise.resolve(() => {
    bus.emit('myevent', {
      time: new Date().toString(),
    })
  }).then(() => {
    bus.off('myevent')
  })
}, 1000)

bus.once('onceEvent', (val) => {
  console.log('ðŸš€ ~ bus.once ~ val:', val)
})

setTimeout(() => {
  bus.emit('onceEvent', {
    once: true,
  })
}, 2000)
```